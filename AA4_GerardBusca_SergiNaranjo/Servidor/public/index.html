<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Columns Online</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:#fff; display:flex; justify-content:center; align-items:center; min-height:100vh; }
  .container { position:relative; width:100%; max-width:400px; padding:20px; box-sizing:border-box; text-align:center; }
  h1 { font-size:1.8em; margin-bottom:15px; }
  input { width:100%; padding:12px; margin-bottom:10px; font-size:1em; border-radius:6px; border:none; }
  button { width:100%; padding:14px; font-size:1em; border:none; border-radius:6px; background:#00bcd4; color:#000; font-weight:bold; margin-top:10px; cursor:pointer; }
  button:active { background:#0097a7; }
  .danger { background:#ff5252; color:#fff; }
  .controls { margin-top:15px; font-size:0.95em; background:#222; padding:10px; border-radius:6px; }
  .players { margin-top:15px; font-size:1.1em; }
  .error { color:#ff5252; margin-top:10px; }
  .room { background:#222; padding:12px; margin-bottom:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
  .room button { width:auto; padding:8px 14px; }

  .user-btn {
    position:absolute;
    top:15px;
    right:15px;
    width:auto;
    padding:8px 14px;
    background:#4caf50;
    color:#000;
    font-weight:bold;
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginDiv" class="container">
  <h1>Columns Online</h1>
  <input type="text" id="username" placeholder="Usuario">
  <input type="password" id="password" placeholder="Contraseña">
  <button id="loginBtn">Entrar</button>
  <button id="registerBtn">Registrarse</button>
  <p id="error" class="error"></p>
</div>

<!-- LOBBY -->
<div id="lobbyDiv" class="container" style="display:none;">
  <h1>Salas</h1>
  <button id="userBtn" class="user-btn">User</button>

  <div class="room"><span>Sala 1</span><button onclick="enterRoom('Sala 1')">Entrar</button></div>
  <div class="room"><span>Sala 2</span><button onclick="enterRoom('Sala 2')">Entrar</button></div>
  <div class="room"><span>Sala 3</span><button onclick="enterRoom('Sala 3')">Entrar</button></div>
  <div class="room"><span>Sala 4</span><button onclick="enterRoom('Sala 4')">Entrar</button></div>

  <button id="logoutBtn" class="danger">Cerrar sesión</button>
</div>

<!-- USER -->
<div id="userDiv" class="container" style="display:none;">
  <h1>Perfil de Usuario</h1>

  <p style="font-size:1.2em;">
    Usuario: <strong id="userNameText"></strong>
  </p>

  <!-- HORA EXACTA -->
  <p style="font-size:1.2em;">
    Hora actual: <strong id="timeText"></strong>
  </p>

  <button id="backToLobbyBtn">Volver</button>
</div>

<!-- SALA -->
<div id="roomDiv" class="container" style="display:none;">
  <h1 id="roomTitle"></h1>
  <div class="controls">
    ⬅ Izquierda · ➡ Derecha<br>
    ⬇ Bajar · ⬆ Rotar
  </div>
  <div class="players">
    Jugadores: <span id="players">0</span>
  </div>
  <button id="leaveBtn" class="danger">Salir de la sala</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let inRoom = false;
let currentRoom = null;
let currentUser = null;

// reloj
let clockInterval = null;

const users = { admin: "1234" };

// ELEMENTOS
const loginDiv = document.getElementById("loginDiv");
const lobbyDiv = document.getElementById("lobbyDiv");
const roomDiv = document.getElementById("roomDiv");
const userDiv = document.getElementById("userDiv");

const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const errorText = document.getElementById("error");

const roomTitle = document.getElementById("roomTitle");
const playersText = document.getElementById("players");

const leaveBtn = document.getElementById("leaveBtn");
const logoutBtn = document.getElementById("logoutBtn");

const userBtn = document.getElementById("userBtn");
const userNameText = document.getElementById("userNameText");
const timeText = document.getElementById("timeText");
const backToLobbyBtn = document.getElementById("backToLobbyBtn");

// LOGIN
document.getElementById("loginBtn").addEventListener("click", () => {
  const u = usernameInput.value.trim();
  const p = passwordInput.value.trim();
  if(users[u] && users[u] === p){
    currentUser = u;
    loginSuccess();
  } else {
    errorText.innerText="Usuario o contraseña incorrectos";
  }
});

document.getElementById("registerBtn").addEventListener("click", () => {
  const u = usernameInput.value.trim();
  const p = passwordInput.value.trim();
  if(!u||!p){ errorText.innerText="Debes escribir usuario y contraseña"; return; }
  if(users[u]){ errorText.innerText="El usuario ya existe"; return; }
  users[u] = p;
  currentUser = u;
  loginSuccess();
});

function loginSuccess(){
  loginDiv.style.display="none";
  lobbyDiv.style.display="block";
  errorText.innerText="";
}

// USER
userBtn.addEventListener("click", () => {
  lobbyDiv.style.display="none";
  userDiv.style.display="block";
  userNameText.innerText = currentUser;
  startClock();
});

backToLobbyBtn.addEventListener("click", () => {
  stopClock();
  userDiv.style.display="none";
  lobbyDiv.style.display="block";
});

// RELOJ
function startClock(){
  updateTime();
  clockInterval = setInterval(updateTime, 1000);
}

function stopClock(){
  clearInterval(clockInterval);
  clockInterval = null;
}

function updateTime(){
  timeText.innerText = new Date().toLocaleTimeString();
}

// ENTRAR A SALA
function enterRoom(roomName){
  currentRoom = roomName;
  lobbyDiv.style.display="none";
  roomDiv.style.display="block";
  roomTitle.innerText = roomName;
  inRoom = true;
  socket.emit("joinRoom",{roomName});
}
window.enterRoom = enterRoom;

// SALIR DE SALA
leaveBtn.addEventListener("click",()=>{
  socket.emit("leaveRoom",{roomName: currentRoom});
  currentRoom=null;
  inRoom=false;
  roomDiv.style.display="none";
  lobbyDiv.style.display="block";
});

// CERRAR SESIÓN
logoutBtn.addEventListener("click",()=>{location.reload();});

// CONTROLES
function sendMove(direction){socket.emit("playerMove",direction);}
document.addEventListener("keydown",(e)=>{
  if(!inRoom) return;
  switch(e.key){
    case "ArrowLeft": sendMove("Izquierda"); break;
    case "ArrowRight": sendMove("Derecha"); break;
    case "ArrowDown": sendMove("Abajo"); break;
    case "ArrowUp": sendMove("Arriba"); break;
  }
});

// ACTUALIZAR JUGADORES
socket.on("roomUpdate",({players})=>{
  if(inRoom){
    playersText.innerText=players;
  }
});
</script>
</body>
</html>